@inherits LayoutComponentBase

<EditForm Model="@studentUpdated" OnValidSubmit="HandleValidSubmit" class="d-flex flex-column gap-2 my-2">
	<DataAnnotationsValidator />

	<div class="text-end">
		@if (IsReadonly)
		{
			<ButtonEdit OnClick="ToggleReadonly" Text="Edit"/>
		}
	</div>

	<div class="form-floating">
		<InputNumber class="form-control"
					 readonly="@IsReadonly"
					 id="student-id"
					 min="@Student.AllowedIdRange.Min"
					 max="@Student.AllowedIdRange.Max"
					 @bind-Value="studentUpdated!.Id" />
		<label for="student-id">OM</label>
		<ValidationMessage For="() => studentUpdated.Id" />
	</div>

	<div class="input-group gap-2">
		<label class="input-group-text user-select-none col-12 rounded gap-2" for="givenName">
			Name
			@if (!IsReadonly && studentUpdated.GetFullName().Length > 2)
			{
				<span>[@studentUpdated.GetFullName()]</span>

			}
		</label>

		<div class="form-floating col-12 col-md">
			<InputText class="form-control" readonly="@IsReadonly" placeholder="First name" id="givenName" @bind-Value="studentUpdated.FirstName" />
			<label for="given-name">First</label>
			<ValidationMessage For="() => studentUpdated.FirstName" />
		</div>

		<div class="form-floating col-12 col-md">
			<InputText class="form-control" readonly="@IsReadonly" placeholder="Last name" id="lastName" @bind-Value="studentUpdated.LastName" />
			<label for="last-name">Last</label>
			<ValidationMessage For="() => studentUpdated.LastName" />
		</div>

		<div class="form-floating col-12 col-md">
			<InputText class="form-control" readonly="@IsReadonly" placeholder="Middle name" id="middleName" @bind-Value="studentUpdated.MiddleName" />
			<label for="middle-name">Middle</label>
			<ValidationMessage For="() => studentUpdated.MiddleName" />
		</div>
	</div>

	<div class="input-group gap-2 align-items-center">
		<label class="input-group-text user-select-none col-12 rounded gap-2" for="class-year-select">
			Class
			@if (!IsReadonly && studentUpdated.ClassYear != string.Empty)
			{
				<br />
				<span>[@studentUpdated.Class]</span>
			}
		</label>

		<div class="form-floating col">
			<InputSelect class="form-select" id="class-year-select" disabled="@IsReadonly" @bind-Value="studentUpdated.ClassYear">
				@foreach(string year in Student.AllowedYears)
				{
					<option value="@year" selected="@year.Equals(studentUpdated.ClassYear)">@year</option>
				}
			</InputSelect>
			<label for="class-year-select">Year</label>
		</div>

		<div class="form-floating col">
			<InputSelect class="form-select" id="class-group-select" disabled="@IsReadonly" @bind-Value="studentUpdated.ClassGroup">
				@foreach (var group in Student.AllowedGroups)
				{
					<option value="@group" selected="@group.Equals(studentUpdated.ClassGroup)">@group</option>
				}
			</InputSelect>
			<label for="class-group-select">Group</label>
		</div>
	</div>
	<ValidationMessage For="() => studentUpdated.Class" />

	<div class="form-floating">
		<InputText class="form-control" readonly="@IsReadonly" id="username" @bind-Value="studentUpdated.Username" />
		<label for="username">Username</label>
		<ValidationMessage For="() => studentUpdated.Username" />
	</div>

	<div class="form-floating">
		<InputNumber class="form-control"
					 readonly="@IsReadonly"
					 id="user-id"
					 min="@Student.AllowedUidRange.Min"
					 max="@Student.AllowedUidRange.Max"
					 @bind-Value="studentUpdated.Uid" />
		<label for="user-id">User Id</label>
		<ValidationMessage For="() => studentUpdated.Uid" />
	</div>

	<div class="form-floating">
		<InputNumber class="form-control"
					 readonly="@IsReadonly"
					 id="group-id"
					 min="@Student.AllowedGidRange.Min"
					 max="@Student.AllowedGidRange.Max"
					 @bind-Value="studentUpdated.Gid" />
		<label for="group-id">Group Id</label>
		<ValidationMessage For="() => studentUpdated.Gid" />
	</div>

	<div class="form-floating">
		<InputText class="form-control" readonly="@IsReadonly" id="email" placeholder="Student@example.com" @bind-Value="studentUpdated.Email" />
		<label for="email">Email</label>
		<ValidationMessage For="() => studentUpdated.Email" />
	</div>

	<div class="form-floating">
		<InputText class="form-control" readonly="@IsReadonly" id="home-directory" placeholder="/home/Student" @bind-Value="studentUpdated.HomeDirectory" />
		<label for="home-directory">Directory</label>
		<ValidationMessage For="() => studentUpdated.HomeDirectory" />
	</div>

	<div class="form-floating">
		<InputText type="password" class="form-control" readonly="@IsReadonly" id="password" @bind-Value="studentUpdated.Password" />
		<label for="password">Password</label>
		<ValidationMessage For="() => studentUpdated.Password" />
	</div>

	@if (!IsReadonly)
	{
		<div class="d-flex justify-content-end gap-2">
			@if (CanDelete)
			{
				<ButtonDelete OnClick="ToggleReadonly" Text="Delete"/>
			}
			<ButtonCancel OnClick="ToggleReadonly" Text="Cancel"/>
			<ButtonSubmit Text="Submit" />
		</div>
	}
</EditForm>

@code {
	[Parameter]
	public Student TheStudent { get; set; } = StudentFactory.CreateEmptyStudent().Build();

	[Parameter]
	public EventCallback<Student> OnSubmit { get; set; }

	[Parameter]
	public bool IsReadonly { get; set; }

	[Parameter]
	public bool CanDelete { get; set; }

	private Student studentOriginal = StudentFactory.CreateEmptyStudent().Build();
	private Student studentUpdated = StudentFactory.CreateEmptyStudent().Build();

	protected override void OnInitialized()
	{
		studentOriginal = Utils.GetClone<Student>(TheStudent)!;
		studentUpdated = Utils.GetClone<Student>(studentOriginal)!;
	}

	protected override void OnParametersSet() => StateHasChanged();

	private async Task HandleValidSubmit()
	{
		Console.WriteLine("AWAITING UPDATE");
		await OnSubmit.InvokeAsync(studentUpdated);
	}

	private void ToggleReadonly()
	{
		studentUpdated = Utils.GetClone<Student>(studentOriginal)!;
		IsReadonly = !IsReadonly;
	}
}
