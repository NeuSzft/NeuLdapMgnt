@page "/students"

<PageTitle>Students</PageTitle>

<div class="row justify-content-between g-2">
	<div class="col">
		<h1>Students [@StudentService.Students.Count]</h1>
	</div>
	<div class="col text-end">
		<ButtonRefresh OnClick="OnRefresh" Text="Refresh" />
	</div>
</div>

@if (isLoading)
{
	<Loading Text="Loading students" />
}
else if (isUpdating)
{
	<Loading Text="Updating students" />
}
else if (isDeleting)
{
	<Loading Text="Deleting students" />
}
else if (!StudentService.Students.Any())
{
	<div class="d-flex justify-content-center text-center">
		<div>
			<h3 class="my-4">There are no <strong>[Active]</strong> students</h3>
			<ButtonAdd Text="Add Students" OnClick="ToAddPage" />
			<Button Color="ButtonColor.Dark" Outline="true" Class="ms-3" @onclick="ToInactivesPage">
				<i class="bi bi-eye"></i>
				View
				<strong>[Inactives]</strong>
			</Button>
		</div>
	</div>
}
else
{
	<TableStudents Students="StudentService.Students"
				   OnStudentsUpdate="HandleUpdateStudents" />
}

@code {
	private bool isLoading = true;
	private bool isDeleting = false;
	private bool isUpdating = false;

	protected override async Task OnInitializedAsync()
	{
		ApiRequests.EnsureAuthentication(NavManager);
		await LocalDbService.FetchClassesAsync();
		await StudentService.FetchStudentsAsync();
		isLoading = false;
	}

	private async Task HandleUpdateStudents((List<Student>, string, bool) context)
	{
		var (students, cls, isInactive) = context;
		isUpdating = true;
		await StudentService.UpdateStudentsAsync(students, cls, isInactive);
		await OnRefresh();
		isUpdating = false;
	}

	private async Task OnRefresh()
	{
		isLoading = true;
		await StudentService.FetchStudentsAsync();
		isLoading = false;
	}

	private void ToAddPage() => NavManager.NavigateTo("/students/add");
	private void ToInactivesPage() => NavManager.NavigateTo("/db/inactive-users");
}


