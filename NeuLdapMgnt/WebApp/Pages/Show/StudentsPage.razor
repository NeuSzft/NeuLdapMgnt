@page "/students"

<PageTitle>Students</PageTitle>

<div class="row justify-content-between g-2">
	<div class="col">
		<h1>Students</h1>
	</div>
	<div class="col text-end">
		<ButtonRefresh OnClick="RefreshStudents" Text="Refresh"/>
	</div>
</div>

@if (isLoading)
{
	<Loading Text="Loading students" />
}
else if (!Lists.Students.Any())
{
	<div class="d-flex justify-content-center text-center">
		<div>
			<h3 class="my-4">There are no students in the database</h3>
			<ButtonAdd Text="Add Students" OnClick="ToAddPage"/>
		</div>
	</div>
}
else
{
	<TableStudents Students="Lists.GetStudents()" />
}

@code {
	private bool isLoading { get; set; }

	protected override async Task OnInitializedAsync()
	{
		ApiRequests.EnsureAuthentication(NavManager);
		await RefreshStudents();
	}

	private async Task RefreshStudents()
	{
		try
		{
			isLoading = true;
			Lists.Students.Clear();

			var response = await ApiRequests.GetStudentsAsync();
			if (response.IsSuccess())
			{
				Lists.Students = new(response.Values);
				isLoading = false;
			}

			if (response.Errors.Any())
			{
				await ModalService.ShowAsync(ModalOptions.Error(response.GetError()));
			}

			StateHasChanged();
		}
		catch (HttpRequestException httpError)
		{
			if (httpError.Message.Contains("Failed to fetch"))
			{
				ToastService.Notify(ToastMessages.NoConnection());
			}
			else
			{
				ToastService.Notify(ToastMessages.Error(httpError.Message));
			}
		}
		catch (Exception e)
		{
			ToastService.Notify(ToastMessages.Error(e.Message));
		}
	}

	private void ToAddPage()
	{
		NavManager.NavigateTo("/students/add");
	}
}


